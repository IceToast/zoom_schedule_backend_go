name: Go Build & Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build_deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15

    - name: Build
      run: go build -o dist/zoom_schedule_api
    
    - name: SSH Deploy
      # You may pin to the exact commit or the version.
      # uses: easingthemes/ssh-deploy@191986574c0735ffad7ae1a297a414d6e6f95375
      uses: easingthemes/ssh-deploy@v2.1.5
      with:
        # Private Key
        SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
        # Remote host
        REMOTE_HOST:  ${{secrets.SSH_REMOTE_HOST}}
        # Remote user
        REMOTE_USER:  ${{secrets.SSH_REMOTE_USER}}
        # Remote port
        REMOTE_PORT: 22
        # Source directory
        SOURCE: dist/
        # Target directory
        TARGET:  ${{secrets.SSH_TARGET_DIRECTORY}}
        # Arguments to pass to rsync
        ARGS: "-rltgoDzvO --exclude='.env' --delete"
          
    - name: SSH Remote Command
      uses: appleboy/ssh-action@v0.1.3
      with:
       host: ${{secrets.SSH_REMOTE_HOST}}
       key:  ${{secrets.SSH_PRIVATE_KEY}}
       username: ${{secrets.SSH_REMOTE_USER}}
       script: |
        screen -X -S zoom_schedule_backend quit
        screen -dmS zoom_schedule_backend ${{secrets.SSH_TARGET_DIRECTORY}}zoom_schedule_api
